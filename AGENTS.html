<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Agent Guide for R Package Development • coinpi</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css"><script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet"><script src="pkgdown.js"></script><meta property="og:title" content="Agent Guide for R Package Development"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">


    <div class="container template-title-body">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">coinpi</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="articles/coin-flip-pi.html">Computing Pi by Flipping a Coin</a>
    </li>
  </ul></li>
      </ul><ul class="nav navbar-nav navbar-right"></ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->



      </header><div class="row">
  <div class="contents col-md-9">
    <div class="page-header">
      <h1>Agent Guide for R Package Development</h1>
    </div>

<div id="agent-guide-for-r-package-development" class="section level1">

<p>Essential rules for R package development with Nix, rix, and reproducible workflows. For detailed guidance, invoke the relevant skill.</p>
<div class="section level2">
<h2 id="session-start">Session Start<a class="anchor" aria-label="anchor" href="#session-start"></a></h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># Verify nix shell</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$IN_NIX_SHELL</span>  <span class="co"># Should be 1 or impure</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">which</span> R             <span class="co"># Should be /nix/store/...</span></span></code></pre></div>
<p>If not in nix: <code>caffeinate -i ~/docs_gh/rix.setup/default.sh</code></p>
<p>Check: <code>.claude/CURRENT_WORK.md</code>, <code>git status</code>, open issues.</p>
</div>
<div class="section level2">
<h2 id="project-specific-nix-environments-updated">Project-Specific Nix Environments (UPDATED)<a class="anchor" aria-label="anchor" href="#project-specific-nix-environments-updated"></a></h2>
<p><strong>For each R package project</strong>, create a project-specific Nix environment with persistent GC root:</p>
<ol style="list-style-type: decimal"><li>
<p><strong>Create <code>default.R</code></strong> - Generates <code>default.nix</code> from DESCRIPTION:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Reads DESCRIPTION and creates default.nix with rix()</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"default.R"</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Create <code>default.sh</code></strong> with GC root - Fast, persistent Nix shell:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">chmod</span> +x default.sh</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="ex">./default.sh</span>  <span class="co"># First run: builds and creates nix-shell-root</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="ex">./default.sh</span>  <span class="co"># Subsequent runs: FAST (seconds, not minutes!)</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co"># To force rebuild:</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="fu">rm</span> nix-shell-root <span class="kw">&amp;&amp;</span> <span class="ex">./default.sh</span></span></code></pre></div>
</li>
<li>
<p><strong>Key Features</strong>:</p>
<ul><li>
<strong>Persistent GC root</strong> (<code>nix-shell-root</code>) prevents garbage collection</li>
<li>
<strong>Fast subsequent runs</strong> - packages cached in <code>/nix/store/</code>
</li>
<li>All DESCRIPTION dependencies available</li>
<li>No missing package errors in Shiny apps</li>
<li>Reproducible across machines</li>
</ul></li>
<li>
<p><strong>Files created</strong>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>project<span class="sc">/</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>├── default.R          <span class="co"># Generates default.nix from DESCRIPTION</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>├── default.sh         <span class="co"># Enters Nix shell with GC root</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>├── default.nix        <span class="co"># Generated Nix configuration</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>└── nix<span class="sc">-</span>shell<span class="sc">-</span>root     <span class="co"># Symlink to /nix/store (GC protection)</span></span></code></pre></div>
</li>
<li>
<p><strong>CRITICAL: Always exclude Nix files from git and R builds</strong>:</p>
<p><strong>Add to <code>.gitignore</code>:</strong></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>nix<span class="sc">-</span>shell<span class="sc">-</span>root</span></code></pre></div>
<p><strong>Add to <code>.Rbuildignore</code>:</strong></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="sc">^</span>nix<span class="sc">-</span>shell<span class="sc">-</span>root<span class="sc">$</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="er">^</span>default\.R<span class="sc">$</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="er">^</span>default\.nix<span class="sc">$</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="er">^</span>default\.sh<span class="sc">$</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="er">^</span>default<span class="sc">-</span>ci\.nix<span class="sc">$</span></span></code></pre></div>
<p>Why: nix-shell-root is a symlink to /nix/store that doesn’t exist in CI/other machines</p>
</li>
<li>
<p><strong>Testing examples in Nix</strong>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="ex">./default.sh</span>  <span class="co"># Enter Nix environment</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="ex">R</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="op">&gt;</span> library<span class="kw">(</span><span class="ex">randomwalk</span><span class="kw">)</span>  <span class="co"># Latest version from johngavin cachix cache</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="op">&gt;</span> <span class="co"># Or for development:</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="op">&gt;</span> devtools::load_all<span class="kw">()</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="op">&gt;</span> <span class="co"># Run your examples here - all packages available!</span></span></code></pre></div>
<p><strong>Note</strong>: Project-specific default.nix automatically uses johngavin cachix cache (second priority after rstats-on-nix cache) for pre-built packages</p>
</li>
</ol><p><strong>Reference implementations</strong>: - Simple version: <code>millsratio/default.sh</code> - Advanced version: <code>/Users/johngavin/docs_gh/llm/default.sh</code></p>
</div>
<div class="section level2">
<h2 id="critical-nix-rules-must-read">Critical Nix Rules (MUST READ)<a class="anchor" aria-label="anchor" href="#critical-nix-rules-must-read"></a></h2>
<p><strong>See <code>NIX_RULES.md</code> for detailed explanation</strong></p>
<div class="section level3">
<h3 id="never-install-packages-inside-nix">NEVER Install Packages Inside Nix<a class="anchor" aria-label="anchor" href="#never-install-packages-inside-nix"></a></h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ✗ FORBIDDEN - Breaks Nix immutability</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="op">)</span>       <span class="co"># NO!</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install</span><span class="op">(</span><span class="op">)</span>      <span class="co"># NO!</span></span>
<span><span class="fu">pak</span><span class="fu">::</span><span class="fu">pkg_install</span><span class="op">(</span><span class="op">)</span>       <span class="co"># NO!</span></span>
<span></span>
<span><span class="co"># ✓ ALLOWED - Safe operations</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">load_all</span><span class="op">(</span><span class="op">)</span>     <span class="co"># YES - temporary load</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">document</span><span class="op">(</span><span class="op">)</span>     <span class="co"># YES - updates docs</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">test</span><span class="op">(</span><span class="op">)</span>         <span class="co"># YES - runs tests</span></span></code></pre></div>
<p><strong>To add packages:</strong> Edit DESCRIPTION → Run <code>Rscript default.R</code> → Exit → Re-enter Nix</p>
</div>
<div class="section level3">
<h3 id="description-is-the-single-source-of-truth-for-nix-mandatory">DESCRIPTION is the Single Source of Truth for Nix (MANDATORY)<a class="anchor" aria-label="anchor" href="#description-is-the-single-source-of-truth-for-nix-mandatory"></a></h3>
<p><strong>CRITICAL: NEVER maintain a separate package list for Nix.</strong></p>
<p>All R package dependencies MUST be extracted from DESCRIPTION by <code>default.R</code> using <code>read.dcf("DESCRIPTION")</code>. Manual package lists (like <code>R/dev/nix/packages.R</code>) cause drift where packages exist in DESCRIPTION but are missing from <code>default.nix</code>.</p>
<p><strong>Mandatory pattern for <code>default.R</code>:</strong></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rix/" class="external-link">rix</a></span><span class="op">)</span></span>
<span><span class="va">desc_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dcf.html" class="external-link">read.dcf</a></span><span class="op">(</span><span class="st">"DESCRIPTION"</span><span class="op">)</span></span>
<span><span class="va">parse_field</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">field</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">field</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">desc_raw</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">pkgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">desc_raw</span><span class="op">[</span>, <span class="va">field</span><span class="op">]</span>, <span class="st">",\\s*|\n\\s*"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"\\s*\\([^)]+\\)"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/trimws.html" class="external-link">trimws</a></span><span class="op">(</span><span class="va">pkgs</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="op">(</span>\<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nzchar</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">desc_deps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">parse_field</span><span class="op">(</span><span class="st">"Imports"</span><span class="op">)</span>, <span class="fu">parse_field</span><span class="op">(</span><span class="st">"Suggests"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dev_extras</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mirai"</span>, <span class="st">"nanonext"</span>, <span class="st">"usethis"</span>, <span class="st">"gert"</span>, <span class="st">"gh"</span>,</span>
<span>                <span class="st">"pkgdown"</span>, <span class="st">"styler"</span>, <span class="st">"air"</span>, <span class="st">"spelling"</span><span class="op">)</span></span>
<span><span class="va">r_pkgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">desc_deps</span>, <span class="va">dev_extras</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><strong>Forbidden patterns:</strong> - <code>source("R/dev/nix/packages.R")</code> – manual list, drifts from DESCRIPTION - Hardcoded <code>r_pkgs &lt;- c(...)</code> in <code>default.R</code> – same problem - Any package list not derived from DESCRIPTION</p>
<p><strong>Drift detection (targets pipeline):</strong> Every project MUST include <code>R/tar_plans/plan_nix_sync.R</code> with targets that: 1. Track DESCRIPTION as a file dependency 2. Extract deps via <a href="https://johngavin.github.io/coMMpass/reference/get_description_deps.md" class="external-link"><code>get_description_deps()</code></a> 3. Compare against packages in <code>default.nix</code>, warning on drift</p>
<p><strong>Safe regeneration in <code>default.sh</code>:</strong> NEVER use <code>curl -sl</code> to fetch a remote rix expression for regeneration. Use:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="ex">nix-shell</span> <span class="dt">\</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>  <span class="at">--expr</span> <span class="st">"let pkgs = import &lt;nixpkgs&gt; {}; in pkgs.mkShell {</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="st">    buildInputs = [ pkgs.R pkgs.rPackages.rix pkgs.rPackages.cli</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="st">                    pkgs.rPackages.curl pkgs.curlMinimal pkgs.cacert ]; }"</span> <span class="dt">\</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>  <span class="at">--command</span> <span class="st">"Rscript --vanilla default.R"</span></span></code></pre></div>
<p>Why: <code>import &lt;nixpkgs&gt; {}</code> uses the ambient channel, always matching pre-built binaries. The curl-fetched expression can cause R version mismatch segfaults.</p>
<p><strong><code>default.sh</code> must check DESCRIPTION timestamp</strong> (not a separate packages.R):</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="cf">elif</span> <span class="bu">[</span> <span class="st">"</span><span class="va">$PROJECT_PATH</span><span class="st">/DESCRIPTION"</span> <span class="ot">-nt</span> <span class="st">"</span><span class="va">$NIX_FILE</span><span class="st">"</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"DESCRIPTION has been modified since default.nix was generated."</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>    <span class="va">NEED_REGEN</span><span class="op">=</span>true</span></code></pre></div>
<p><strong>Cachix push CI:</strong> Every project SHOULD include a CI workflow (e.g., <code>06-push-cachix.yaml</code>) that runs <code>./push_to_cachix.sh</code> after the package check passes on main. This uses <code>cachix watch-exec</code> which pushes ONLY the project derivation, not dependencies.</p>
<p><strong>Reference implementation:</strong> coMMpass project (Feb 2026).</p>
</div>
<div class="section level3">
<h3 id="never-use-ide-in-project-specific-nix-shells">NEVER Use IDE in Project-Specific Nix Shells<a class="anchor" aria-label="anchor" href="#never-use-ide-in-project-specific-nix-shells"></a></h3>
<p><strong>CRITICAL:</strong> Project-specific <code>default.R</code> must ALWAYS use <code>ide = "none"</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ✗ FORBIDDEN - Builds RStudio/VS Code from source (30+ minutes!)</span></span>
<span><span class="fu">rix</span><span class="op">(</span><span class="va">...</span>, ide <span class="op">=</span> <span class="st">"rstudio"</span>, <span class="va">...</span><span class="op">)</span>   <span class="co"># NO!</span></span>
<span><span class="fu">rix</span><span class="op">(</span><span class="va">...</span>, ide <span class="op">=</span> <span class="st">"code"</span>, <span class="va">...</span><span class="op">)</span>      <span class="co"># NO!</span></span>
<span><span class="fu">rix</span><span class="op">(</span><span class="va">...</span>, ide <span class="op">=</span> <span class="st">"positron"</span>, <span class="va">...</span><span class="op">)</span>  <span class="co"># NO!</span></span>
<span></span>
<span><span class="co"># ✓ CORRECT - IDE comes from the development shell, not the project shell</span></span>
<span><span class="fu">rix</span><span class="op">(</span><span class="va">...</span>, ide <span class="op">=</span> <span class="st">"none"</span>, <span class="va">...</span><span class="op">)</span>      <span class="co"># YES - always use this</span></span></code></pre></div>
<p><strong>Why:</strong> - The <strong>development shell</strong> (<code>~/docs_gh/rix.setup/default.sh</code>) already provides RStudio/IDE - Project shells only need R + packages from DESCRIPTION - Building an IDE in each project shell wastes 30+ minutes compiling from source - Project shells are entered via <code>nix-shell --run</code> by agents (non-interactive, no IDE needed)</p>
<p><strong>If you see <code>ide = "rstudio"</code> or any other IDE value in a project’s <code>default.R</code>, fix it immediately.</strong></p>
</div>
<div class="section level3">
<h3 id="warning-nix-segfaults---recurring-issue-must-read">⚠️ Nix Segfaults - RECURRING ISSUE (MUST READ)<a class="anchor" aria-label="anchor" href="#warning-nix-segfaults---recurring-issue-must-read"></a></h3>
<p><strong>CRITICAL:</strong> <code>dyn.load</code> segfaults in Nix shells are a <strong>PERSISTENT RECURRING ISSUE</strong> caused by R version mismatches!</p>
<p><strong>The Error:</strong></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="sc">**</span><span class="er">*</span> caught segfault <span class="sc">**</span><span class="er">*</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>address <span class="dv">0x0</span>, cause <span class="st">'invalid permissions'</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>Traceback<span class="sc">:</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a> <span class="dv">1</span><span class="sc">:</span> <span class="fu">dyn.load</span>(file, <span class="at">DLLpath =</span> DLLpath, ...)</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a> <span class="dv">2</span><span class="sc">:</span> <span class="fu">library.dynam</span>(lib, package, package.lib)</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a> <span class="dv">3</span><span class="sc">:</span> <span class="fu">loadNamespace</span>(...)</span></code></pre></div>
<p><strong>Root Cause:</strong> Binary incompatibility between R version in <code>default.nix</code> date and pre-built packages in cachix. - Example: Date <code>2025-10-27</code> uses R 4.5.1, but cachix has R 4.5.2 binaries → SEGFAULT</p>
</div>
<div class="section level3">
<h3 id="fix-pattern-mandatory">Fix Pattern (MANDATORY)<a class="anchor" aria-label="anchor" href="#fix-pattern-mandatory"></a></h3>
<ol style="list-style-type: decimal"><li>
<p><strong>Use <a href="https://docs.ropensci.org/rix/reference/available_dates.html" class="external-link"><code>rix::available_dates()</code></a> to find compatible dates:</strong></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rix/" class="external-link">rix</a></span><span class="op">)</span></span>
<span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu">available_dates</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">dates</span>, <span class="fl">10</span><span class="op">)</span>  <span class="co"># See most recent dates</span></span></code></pre></div>
</li>
<li>
<p><strong>Select date with R version matching cachix binaries:</strong></p>
<ul><li>Check cachix for current R version (usually 4.5.2 as of Feb 2026)</li>
<li>Use matching date in <code>default.R</code> (e.g., <code>2026-01-05</code> for R 4.5.2)</li>
</ul></li>
<li>
<p><strong>Regenerate and test:</strong></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co"># Regenerate default.nix</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="ex">Rscript</span> default.R</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="co"># Test ALL packages load</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="ex">nix-shell</span> default.nix <span class="at">--run</span> <span class="st">"Rscript -e 'library(ggplot2); library(dplyr); library(targets)'"</span></span></code></pre></div>
</li>
</ol></div>
<div class="section level3">
<h3 id="rollback-strategy">Rollback Strategy<a class="anchor" aria-label="anchor" href="#rollback-strategy"></a></h3>
<p>If newest rix date doesn’t have all packages built:</p>
<ol style="list-style-type: decimal"><li>
<p><strong>List available dates:</strong></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu">rix</span><span class="fu">::</span><span class="fu">available_dates</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Test older dates until all packages load:</strong></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># In default.R, try progressively older dates</span></span>
<span><span class="fu">rix</span><span class="op">(</span>date <span class="op">=</span> <span class="st">"2026-01-05"</span>, <span class="va">...</span><span class="op">)</span>  <span class="co"># If fails, try older</span></span>
<span><span class="fu">rix</span><span class="op">(</span>date <span class="op">=</span> <span class="st">"2025-12-15"</span>, <span class="va">...</span><span class="op">)</span>  <span class="co"># etc.</span></span></code></pre></div>
</li>
<li>
<p><strong>Verify ALL DESCRIPTION packages load:</strong></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="ex">nix-shell</span> default.nix <span class="at">--run</span> <span class="st">"Rscript -e '</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="st">  pkgs &lt;- c(</span><span class="dt">\"</span><span class="st">ggplot2</span><span class="dt">\"</span><span class="st">, </span><span class="dt">\"</span><span class="st">dplyr</span><span class="dt">\"</span><span class="st">, </span><span class="dt">\"</span><span class="st">targets</span><span class="dt">\"</span><span class="st">, </span><span class="dt">\"</span><span class="st">crew</span><span class="dt">\"</span><span class="st">)</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a><span class="st">  for (pkg in pkgs) library(pkg, character.only = TRUE)</span></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a><span class="st">  cat(</span><span class="dt">\"</span><span class="st">All packages loaded OK</span><span class="dt">\\</span><span class="st">n</span><span class="dt">\"</span><span class="st">)</span></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a><span class="st">'"</span></span></code></pre></div>
</li>
</ol></div>
<div class="section level3">
<h3 id="common-mistakes-to-avoid">Common Mistakes to Avoid<a class="anchor" aria-label="anchor" href="#common-mistakes-to-avoid"></a></h3>
<ul><li>❌ Blaming macOS/OS issues (Nix is OS-independent)</li>
<li>❌ Using arbitrary rix dates without checking R version</li>
<li>❌ Not testing package loading before committing</li>
<li>❌ Assuming newest date always works (may lack pre-built packages)</li>
<li>✅ Always use <a href="https://docs.ropensci.org/rix/reference/available_dates.html" class="external-link"><code>rix::available_dates()</code></a> to select compatible date</li>
<li>✅ Always test <a href="https://rdrr.io/r/base/library.html" class="external-link"><code>library()</code></a> calls in temp nix shell</li>
<li>✅ Match R version in rix date to cachix binaries</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="the-9-step-workflow-mandatory">The 9-Step Workflow (MANDATORY)<a class="anchor" aria-label="anchor" href="#the-9-step-workflow-mandatory"></a></h2>
<p><strong>NO EXCEPTIONS. NO SHORTCUTS.</strong> See <code>r-package-workflow</code> skill for details.</p>
<table class="table"><colgroup><col width="33%"><col width="33%"><col width="33%"></colgroup><thead><tr><th>Step</th>
<th>Action</th>
<th>Key Command</th>
</tr></thead><tbody><tr><td>0</td>
<td>Design &amp; Plan</td>
<td>Create <code>plans/PLAN_*.md</code>
</td>
</tr><tr><td>1</td>
<td>Create Issue</td>
<td><code>gh::gh("POST /repos/...")</code></td>
</tr><tr><td>2</td>
<td>Create Branch</td>
<td><code>usethis::pr_init("fix-issue-123")</code></td>
</tr><tr><td>3</td>
<td>Make Changes</td>
<td>Edit, test (RED-GREEN-REFACTOR)</td>
</tr><tr><td>4a</td>
<td>Run Checks + QA</td>
<td>
<code>document()</code>, <code>test()</code>, <code>check()</code>, adversarial QA, quality gate &gt;= Silver</td>
</tr><tr><td>4b</td>
<td>Run Pipeline</td>
<td>
<a href="https://docs.ropensci.org/targets/reference/tar_make.html" class="external-link"><code>targets::tar_make()</code></a> - <strong>NEVER ask user, always run yourself</strong>
</td>
</tr><tr><td>5</td>
<td>Push Cachix</td>
<td>
<code>./push_to_cachix.sh</code> (requires <code>package.nix</code>)</td>
</tr><tr><td>6</td>
<td>Push GitHub</td>
<td><a href="https://usethis.r-lib.org/reference/pull-requests.html" class="external-link"><code>usethis::pr_push()</code></a></td>
</tr><tr><td>7</td>
<td>Wait for CI</td>
<td>Monitor Nix-based workflows ONLY</td>
</tr><tr><td>8</td>
<td>Merge PR</td>
<td><a href="https://usethis.r-lib.org/reference/pull-requests.html" class="external-link"><code>usethis::pr_merge_main()</code></a></td>
</tr><tr><td>9</td>
<td>Log Everything</td>
<td>Include <code>R/dev/issue/fix_*.R</code> in PR</td>
</tr></tbody></table></div>
<div class="section level2">
<h2 id="data-privacy--telemetry">Data Privacy &amp; Telemetry<a class="anchor" aria-label="anchor" href="#data-privacy--telemetry"></a></h2>
<p><strong>CRITICAL: Confidentiality Guard</strong> - <strong>Low-level telemetry</strong> (e.g., message-level Parquet files) must <strong>NEVER</strong> be uploaded to a public git repository if they contain or potentially contain confidential info. - You must <strong>ASK and get explicit prior approval</strong> before uploading any such data. - <strong>Approval Renewal</strong>: This approval must be renewed with every <strong>minor R package version upgrade</strong> (e.g., 1.1 to 1.2). - Approval does <strong>NOT</strong> need renewal for bug fixes, new features (that don’t trigger minor version jumps), or patch increments (e.g., 1.2.3 to 1.2.4).</p>
</div>
<div class="section level2">
<h2 id="critical-rules">Critical Rules<a class="anchor" aria-label="anchor" href="#critical-rules"></a></h2>
<p><strong>Git/GitHub - Use R packages ONLY:</strong> - <a href="https://docs.ropensci.org/gert/reference/git_commit.html" class="external-link"><code>gert::git_add()</code></a>, <code>git_commit()</code>, <code>git_push()</code> - <a href="https://usethis.r-lib.org/reference/pull-requests.html" class="external-link"><code>usethis::pr_init()</code></a>, <code>pr_push()</code>, <code>pr_merge_main()</code> - <a href="https://gh.r-lib.org/reference/gh.html" class="external-link"><code>gh::gh()</code></a> for GitHub API</p>
<p><strong>Nix Environment:</strong> - One persistent shell per session - Verify with <code>echo $IN_NIX_SHELL</code> - For issues: invoke <code>nix-env</code> agent</p>
<p><strong>Errors - NEVER speculate:</strong> 1. READ the actual error message 2. QUOTE the error before proposing fixes 3. If you can’t access logs, ASK the user</p>
<p><strong>R Version:</strong> Use 4.5.x (current major). Check: <code>R.version.string</code></p>
</div>
<div class="section level2">
<h2 id="versioning-policy">Versioning Policy<a class="anchor" aria-label="anchor" href="#versioning-policy"></a></h2>
<p><strong>Strict Semantic Versioning for Project R Package</strong>: - <strong>Bug Fixes</strong>: Increment the <strong>patch</strong> version (e.g., 1.2.4 to 1.2.5) for every bug fix or set of fixes. - <strong>New Features</strong>: Increment the <strong>minor</strong> version (e.g., 2.3 to 2.4) for every new feature or set of new features. - <strong>Releases</strong>: Every <strong>tagged version</strong> must trigger a <strong>major</strong> release increment (e.g., v2.1.3 to v3.0.0).</p>
</div>
<div class="section level2">
<h2 id="testing-before-commit-mandatory">Testing Before Commit (MANDATORY)<a class="anchor" aria-label="anchor" href="#testing-before-commit-mandatory"></a></h2>
<p><strong>NEVER commit without testing:</strong> 1. Enter project-specific Nix environment (./default.sh or ./default_dev.sh) 2. Run <code>tar_validate()</code> - MUST pass 3. Run <code>tar_make()</code> - MUST run the FULL pipeline, not just one target 4. Check GitHub CI will trigger (modify .github/workflows if needed) 5. Include R/dev/issue/fix_*.R script documenting changes</p>
<p><strong>CRITICAL: tar_make() is YOUR job, NEVER the user’s:</strong> - YOU run <code>tar_make()</code> as part of every PR workflow. NEVER ask the user to run it. - If it fails due to Nix segfaults, document the failure in the commit message. - If new targets save files to <code>inst/extdata/</code>, commit those files. - Use <code>nix-shell default.nix --run "Rscript -e 'targets::tar_make()'"</code> or btw tools.</p>
<p><strong>CRITICAL Testing Requirements:</strong> 1. <strong>Always test via subagents</strong> - Use <code>verbose-runner</code> for any test that produces output 2. <strong>Verify packages are available</strong> - Test library() calls before claiming packages work 3. <strong>Test ALL README code examples</strong> - Every command in README must be tested before committing 4. <strong>Check CI actually succeeds</strong> - Use <code>gh pr checks</code> or <code>gh workflow view</code> to verify 5. <strong>Verify deployment works</strong> - For GitHub Pages, check the site actually exists after merging</p>
<p><strong>Common Testing Mistakes:</strong> - ❌ Testing in wrong Nix environment (e.g., llm instead of project) - ❌ Not running tar_validate() before commit - ❌ Not running tar_make() (NEVER defer to user!) - ❌ Assuming CI will run (check workflow triggers!) - ❌ Providing untested commands in README - ❌ Not verifying package dependencies before use - ❌ Assuming GitHub Pages works without checking - ✅ Always test in project-specific Nix shell - ✅ Always run tar_make() yourself before committing - ✅ Always delegate tests to appropriate subagents - ✅ Always verify outputs before claiming success</p>
</div>
<div class="section level2">
<h2 id="mandatory-qa-protocol-critical---no-exceptions">Mandatory QA Protocol (CRITICAL - NO EXCEPTIONS)<a class="anchor" aria-label="anchor" href="#mandatory-qa-protocol-critical---no-exceptions"></a></h2>
<div class="section level3">
<h3 id="protocol-reference-table">Protocol Reference Table<a class="anchor" aria-label="anchor" href="#protocol-reference-table"></a></h3>
<table class="table"><colgroup><col width="31%"><col width="39%"><col width="28%"></colgroup><thead><tr><th>Protocol</th>
<th>Skill File</th>
<th>When Required</th>
</tr></thead><tbody><tr><td>9-Step Workflow</td>
<td><code>r-package-workflow</code></td>
<td>Every PR</td>
</tr><tr><td>Adversarial QA</td>
<td><code>adversarial-qa</code></td>
<td>Step 4 of every PR</td>
</tr><tr><td>Quality Gates</td>
<td><code>quality-gates</code></td>
<td>Steps 4, 6, 8</td>
</tr><tr><td>TDD</td>
<td><code>test-driven-development</code></td>
<td>Step 3</td>
</tr><tr><td>Systematic Debugging</td>
<td><code>systematic-debugging</code></td>
<td>When checks fail</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="step-4-expanded-the-full-qa-checklist">Step 4 Expanded: The Full QA Checklist<a class="anchor" aria-label="anchor" href="#step-4-expanded-the-full-qa-checklist"></a></h3>
<p>Every PR MUST complete ALL of these before commit:</p>
<ol style="list-style-type: decimal"><li>
<a href="https://devtools.r-lib.org/reference/document.html" class="external-link"><code>devtools::document()</code></a> - Update NAMESPACE/man</li>
<li>
<a href="https://devtools.r-lib.org/reference/test.html" class="external-link"><code>devtools::test()</code></a> - All tests pass (0 failures)</li>
<li>
<code>devtools::check(--as-cran)</code> - 0 errors, 0 warnings</li>
<li>
<strong>Adversarial QA</strong> - Run attack vectors against new/changed exported functions
<ul><li>Use <code>adversarial-qa</code> skill or <code>/qa-package</code> command</li>
<li>Must pass &gt;= 95% of attack vectors</li>
<li>Generate <code>tests/testthat/test-adversarial-*.R</code> for failures found</li>
</ul></li>
<li>
<strong>Quality Gate</strong> - Compute numeric score
<ul><li>Bronze (&gt;=80) required for commit</li>
<li>Silver (&gt;=90) required for PR</li>
<li>Gold (&gt;=95) required for merge to main</li>
</ul></li>
<li>
<strong>Cachix Push</strong> - <code>./push_to_cachix.sh</code> (requires <code>package.nix</code>)
<ul><li>Run directly, do NOT ask user for permission</li>
<li>Script pushes ONLY this project’s R package (1 derivation)</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="never-skip-these">NEVER Skip These<a class="anchor" aria-label="anchor" href="#never-skip-these"></a></h3>
<p>If you are about to commit or create a PR without running adversarial QA and computing a quality gate score, STOP. This is a mandatory requirement, not optional.</p>
</div>
<div class="section level3">
<h3 id="cachix-push-rule-absolute---no-exceptions">Cachix Push Rule (ABSOLUTE - NO EXCEPTIONS)<a class="anchor" aria-label="anchor" href="#cachix-push-rule-absolute---no-exceptions"></a></h3>
<p><strong>Only push THIS PROJECT’S R package to johngavin cachix. NEVER push standard R packages that are already on rstats-on-nix.</strong></p>
<p>Standard R packages (dplyr, arrow, duckdb, ggplot2, targets, etc.) are ALL available from the public <code>rstats-on-nix</code> cache. Pushing them to johngavin wastes limited quota and is forbidden.</p>
<p>When running Step 5, just run <code>./push_to_cachix.sh</code> directly - do not ask the user for confirmation. The script handles validation and errors.</p>
<div class="section level4">
<h4 id="correct-method-cachix-watch-exec">Correct Method: <code>cachix watch-exec</code>
<a class="anchor" aria-label="anchor" href="#correct-method-cachix-watch-exec"></a></h4>
<p>The script uses <code>cachix watch-exec</code> which pushes ONLY paths that Nix actually <strong>builds</strong> during the wrapped command. Dependencies that are <strong>substituted</strong> (downloaded from rstats-on-nix) are NOT pushed.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="co"># CORRECT - pushes only the built derivation (1 path)</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="ex">cachix</span> watch-exec johngavin <span class="at">--watch-mode</span> auto <span class="at">--</span> nix-build package.nix <span class="at">--no-out-link</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="what-not-to-do-anti-patterns">What NOT To Do (Anti-Patterns)<a class="anchor" aria-label="anchor" href="#what-not-to-do-anti-patterns"></a></h4>
<p>All of these push the <strong>entire closure</strong> (all runtime dependencies):</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="co"># WRONG - pushes entire closure (30+ R packages)</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="ex">cachix</span> push johngavin <span class="va">$RESULT</span></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a><span class="co"># WRONG - ALSO pushes entire closure despite common misconception</span></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$RESULT</span> <span class="kw">|</span> <span class="ex">cachix</span> push johngavin</span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a><span class="co"># WRONG - explicitly pushes all transitive dependencies</span></span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a><span class="ex">nix-store</span> <span class="at">-qR</span> <span class="va">$RESULT</span> <span class="kw">|</span> <span class="ex">cachix</span> push johngavin</span></code></pre></div>
<p><strong>Key fact</strong>: <code>cachix push</code> has NO flag to prevent closure pushing. The <code>echo $PATH | cachix push</code> trick does NOT limit what gets pushed. Both <code>cachix push cache /path</code> and <code>echo /path | cachix push cache</code> resolve and push the full runtime closure.</p>
</div>
<div class="section level4">
<h4 id="verification">Verification<a class="anchor" aria-label="anchor" href="#verification"></a></h4>
<p>After pushing, the script counts “Pushing” lines in the log. Expected: 0 (already cached) or 1 (this package only). If &gt; 1: dependencies were built locally instead of substituted. Fix: ensure <code>cachix use rstats-on-nix</code> is configured.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="github-actions-ci-strategy">GitHub Actions CI Strategy<a class="anchor" aria-label="anchor" href="#github-actions-ci-strategy"></a></h2>
<p><strong>CRITICAL: Strategy differs by repository visibility</strong></p>
<div class="section level3">
<h3 id="public-vs-private-repository-ci">Public vs Private Repository CI<a class="anchor" aria-label="anchor" href="#public-vs-private-repository-ci"></a></h3>
<table class="table"><colgroup><col width="33%"><col width="33%"><col width="33%"></colgroup><thead><tr><th>Repo Type</th>
<th>GitHub Actions Minutes</th>
<th>Recommended CI</th>
</tr></thead><tbody><tr><td><strong>Public</strong></td>
<td><strong>Unlimited free</strong></td>
<td>Any (R-universe, r-lib/actions, Nix)</td>
</tr><tr><td><strong>Private</strong></td>
<td>Quota-limited (2,000-3,000/month)</td>
<td>
<strong>Nix-only</strong> (Linux)</td>
</tr></tbody></table><p><strong>Why this matters:</strong> - Public repos: No billing, no minute limits for standard runners - Private repos: macOS = 10x minutes, Windows = 2x minutes vs Linux - Source: <a href="https://docs.github.com/en/billing/managing-billing-for-github-actions/about-billing-for-github-actions" class="external-link">GitHub Actions Billing</a></p>
</div>
<div class="section level3">
<h3 id="public-repositories-eg-randomwalk-irishbuoys">Public Repositories (e.g., randomwalk, irishbuoys)<a class="anchor" aria-label="anchor" href="#public-repositories-eg-randomwalk-irishbuoys"></a></h3>
<p><strong>All CI workflows are acceptable:</strong> - ✅ R-universe workflows (<code>r-universe-org/workflows</code>) - ✅ r-lib/actions (check-standard, etc.) - ✅ Nix-based workflows - ✅ Multi-platform builds (macOS, Windows, Linux)</p>
</div>
<div class="section level3">
<h3 id="private-repositories">Private Repositories<a class="anchor" aria-label="anchor" href="#private-repositories"></a></h3>
<p><strong>Nix-only CI to conserve minutes:</strong> - ❌ <code>usethis::use_github_action("check-standard")</code> - Uses macOS/Windows - ❌ Multi-platform matrix builds - ❌ r-lib/actions workflows (install packages = slow) - ✅ <strong>Nix-based workflows</strong> (<code>runs-on: ubuntu-latest</code> + <code>nix-shell</code>) - ✅ <strong>Single platform</strong> Linux builds only</p>
</div>
<div class="section level3">
<h3 id="documented-exceptions-all-repos">Documented Exceptions (All Repos)<a class="anchor" aria-label="anchor" href="#documented-exceptions-all-repos"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>pkgdown website deployment</strong>:
<ul><li>Build locally with pkgdown::build_site()</li>
<li>Push to gh-pages branch</li>
<li>Why: bslib attempts to install packages in Nix (forbidden)</li>
<li>
<strong>CRITICAL</strong>: Remove <code>nix-shell-root</code> from gh-pages (symlinks break GitHub Pages builds)</li>
</ul></li>
<li>
<strong>Documentation-only workflows</strong>:
<ul><li>May use r-lib/actions for non-code tasks</li>
<li>Never for package testing or building in private repos</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="test-coverage-local-only">Test Coverage (Local Only)<a class="anchor" aria-label="anchor" href="#test-coverage-local-only"></a></h3>
<p>Use <code>covr</code> for local test coverage analysis - no external service needed:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co"># Install covr (if not in DESCRIPTION)</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="ex">install.packages</span><span class="er">(</span><span class="st">"covr"</span><span class="kw">)</span></span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a><span class="co"># Generate package coverage report</span></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a><span class="fu">covr::package_coverage()</span></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a><span class="co"># Generate HTML report for detailed inspection</span></span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a><span class="fu">covr::report()</span></span></code></pre></div>
<p><strong>Why local coverage only:</strong> - Nix immutability prevents external service uploads - Coverage reports are for development iteration, not CI gates - No token management overhead - Faster feedback during development</p>
</div>
<div class="section level3">
<h3 id="standard-ci-environment-variables-mandatory">Standard CI Environment Variables (MANDATORY)<a class="anchor" aria-label="anchor" href="#standard-ci-environment-variables-mandatory"></a></h3>
<p><strong>Every Nix-based workflow MUST set <code>GITHUB_PAT</code> at job level:</strong></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="at">  </span><span class="fu">my-job</span><span class="kw">:</span></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a><span class="at">    </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a><span class="at">      </span><span class="fu">GITHUB_PAT</span><span class="kw">:</span><span class="at"> ${{ secrets.GITHUB_TOKEN }}</span></span></code></pre></div>
<p><strong>Why:</strong> Prevents GitHub API rate limits in <code>remotes::</code>, <code>pak::</code>, and <code>rix::</code> calls. Both b-rodrigues/nix_targets_pipeline and the official ropensci/targets CI template set this.</p>
</div>
<div class="section level3">
<h3 id="nix-installer-options-mandatory">Nix Installer Options (MANDATORY)<a class="anchor" aria-label="anchor" href="#nix-installer-options-mandatory"></a></h3>
<p><strong>Every workflow using <code>DeterminateSystems/nix-installer-action</code> MUST include verbose logging:</strong></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> DeterminateSystems/nix-installer-action@main</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a><span class="at">          </span><span class="fu">logger</span><span class="kw">:</span><span class="at"> pretty</span></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a><span class="at">          </span><span class="fu">log-directives</span><span class="kw">:</span><span class="at"> nix_installer=trace</span></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a><span class="at">          </span><span class="fu">backtrace</span><span class="kw">:</span><span class="at"> full</span></span></code></pre></div>
<p><strong>Why:</strong> Without these, Nix install failures produce opaque error messages. Verbose logging enables fast CI debugging.</p>
</div>
<div class="section level3">
<h3 id="pipeline-validation-mandatory-for-targets-projects">Pipeline Validation (MANDATORY for targets projects)<a class="anchor" aria-label="anchor" href="#pipeline-validation-mandatory-for-targets-projects"></a></h3>
<p><strong>Every project with <code>_targets.R</code> MUST run <code>tar_validate()</code> in R-CMD-check:</strong></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Validate targets pipeline</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a><span class="at">        </span><span class="fu">if</span><span class="kw">:</span><span class="at"> hashFiles('_targets.R') != ''</span></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>          nix-shell default.nix -A shell --run "Rscript -e '</span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>            targets::tar_validate()</span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>            cat(\"Pipeline valid:\", length(targets::tar_manifest()\$name), \"targets\\n\")</span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a>          '"</span></code></pre></div>
<p><strong>Why:</strong> Catches pipeline definition errors (syntax, missing functions, circular deps) on every push/PR. Fast (&lt; 5s). Full <code>tar_make()</code> runs on schedule/manual trigger.</p>
</div>
<div class="section level3">
<h3 id="checkout-version-mandatory">Checkout Version (MANDATORY)<a class="anchor" aria-label="anchor" href="#checkout-version-mandatory"></a></h3>
<p><strong>Always use <code>actions/checkout@v6</code></strong> (latest major version as of Feb 2026).</p>
</div>
</div>
<div class="section level2">
<h2 id="tool-preferences">Tool Preferences<a class="anchor" aria-label="anchor" href="#tool-preferences"></a></h2>
<table class="table"><colgroup><col width="50%"><col width="50%"></colgroup><thead><tr><th>Task</th>
<th>Tool</th>
</tr></thead><tbody><tr><td>Parallel tasks</td>
<td><a href="https://mirai.r-lib.org/reference/mirai_map.html" class="external-link"><code>mirai::mirai_map()</code></a></td>
</tr><tr><td>Worker pools</td>
<td><a href="https://wlandau.github.io/crew/reference/crew_controller_local.html" class="external-link"><code>crew::crew_controller_local()</code></a></td>
</tr><tr><td>SQL on files</td>
<td><code>duckdb</code></td>
</tr><tr><td>Large data I/O</td>
<td><code>arrow</code></td>
</tr><tr><td>Data manipulation</td>
<td>
<code>dplyr</code> (duckdb/arrow backend)</td>
</tr><tr><td>Pipelines</td>
<td>
<code>targets</code> + <code>crew</code>
</td>
</tr><tr><td>Package API docs</td>
<td>
<code>pkgctx</code> (via nix run)</td>
</tr><tr><td>Errors &amp; Messages</td>
<td>
<a href="https://cli.r-lib.org/reference/cli_abort.html" class="external-link"><code>cli::cli_abort()</code></a>, <code>cli_alert()</code>
</td>
</tr></tbody></table></div>
<div class="section level2">
<h2 id="package-context-for-llms-pkgctx---mandatory">Package Context for LLMs (pkgctx) - MANDATORY<a class="anchor" aria-label="anchor" href="#package-context-for-llms-pkgctx---mandatory"></a></h2>
<p><strong>Every R package project MUST include up-to-date .ctx.yaml files.</strong></p>
<div class="section level3">
<h3 id="what-is-pkgctx">What is pkgctx?<a class="anchor" aria-label="anchor" href="#what-is-pkgctx"></a></h3>
<p><a href="https://github.com/b-rodrigues/pkgctx" class="external-link">pkgctx</a> generates compact YAML files describing every function, its arguments, and purpose. These files: - Reduce token usage by ~67% compared to full documentation - Provide Claude with accurate API information - Enable better code suggestions and fewer hallucinations</p>
</div>
<div class="section level3">
<h3 id="mandatory-files">Mandatory Files<a class="anchor" aria-label="anchor" href="#mandatory-files"></a></h3>
<p>Every project must have:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>inst<span class="sc">/</span>extdata<span class="sc">/</span>ctx<span class="sc">/</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>├── <span class="sc">&lt;</span>package_name<span class="sc">&gt;</span>.ctx.yaml   <span class="co"># Current package API</span></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>├── dplyr.ctx.yaml            <span class="co"># Key dependencies</span></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>├── targets.ctx.yaml</span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>├── ...</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="generation-commands">Generation Commands<a class="anchor" aria-label="anchor" href="#generation-commands"></a></h3>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="co"># Generate context for current package</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="ex">nix</span> run github:b-rodrigues/pkgctx <span class="at">--</span> r . <span class="at">--compact</span> <span class="op">&gt;</span> inst/extdata/ctx/mypackage.ctx.yaml</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a><span class="co"># Generate context for a CRAN dependency</span></span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a><span class="ex">nix</span> run github:b-rodrigues/pkgctx <span class="at">--</span> r dplyr <span class="at">--compact</span> <span class="op">&gt;</span> inst/extdata/ctx/dplyr.ctx.yaml</span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a><span class="co"># Generate context for Bioconductor package</span></span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a><span class="ex">nix</span> run github:b-rodrigues/pkgctx <span class="at">--</span> r bioc:GenomicRanges <span class="at">--compact</span> <span class="op">&gt;</span> inst/extdata/ctx/GenomicRanges.ctx.yaml</span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a><span class="co"># Generate context for GitHub package</span></span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a><span class="ex">nix</span> run github:b-rodrigues/pkgctx <span class="at">--</span> r github:ropensci/rix <span class="at">--compact</span> <span class="op">&gt;</span> inst/extdata/ctx/rix.ctx.yaml</span>
<span id="cb26-12"><a href="#cb26-12" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" tabindex="-1"></a><span class="co"># Generate context for Python package</span></span>
<span id="cb26-14"><a href="#cb26-14" tabindex="-1"></a><span class="ex">nix</span> run github:b-rodrigues/pkgctx <span class="at">--</span> python requests <span class="at">--compact</span> <span class="op">&gt;</span> inst/extdata/ctx/requests.ctx.yaml</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="workflow-integration">Workflow Integration<a class="anchor" aria-label="anchor" href="#workflow-integration"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>targets pipeline</strong>: Use <code>plan_pkgctx.R</code> to auto-generate context files</li>
<li>
<strong>Session start</strong>: Verify <code>.ctx.yaml</code> files are current</li>
<li>
<strong>Before commit</strong>: Regenerate if package API changed</li>
<li>
<strong>Priority packages</strong>: Always generate context for these dependencies:
<ul><li>dplyr, tidyr, purrr, ggplot2, tibble</li>
<li>targets, DBI, duckdb, arrow, pointblank</li>
<li>cli, rlang, httr2, jsonlite, lubridate</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="targets-integration">targets Integration<a class="anchor" aria-label="anchor" href="#targets-integration"></a></h3>
<p>Add to <code>R/tar_plans/plan_pkgctx.R</code>:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plan_pkgctx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">pkgctx_self</span>,</span>
<span>    <span class="fu">run_pkgctx</span><span class="op">(</span><span class="st">"."</span>, <span class="st">"inst/extdata/ctx/mypackage.ctx.yaml"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">pkgctx_deps</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dplyr"</span>, <span class="st">"targets"</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">pkg</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">run_pkgctx</span><span class="op">(</span><span class="va">pkg</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"inst/extdata/ctx/%s.ctx.yaml"</span>, <span class="va">pkg</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="when-to-regenerate">When to Regenerate<a class="anchor" aria-label="anchor" href="#when-to-regenerate"></a></h3>
<ul><li>After adding/removing exported functions</li>
<li>After changing function signatures</li>
<li>After updating DESCRIPTION dependencies</li>
<li>Weekly (context files may become stale)</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="error-handling">Error Handling<a class="anchor" aria-label="anchor" href="#error-handling"></a></h2>
<p><strong>Use Tidyverse Style (cli/rlang):</strong> - <strong>❌ BAD:</strong> <code>stop("Error occurred")</code> - <strong>✅ GOOD:</strong> <code>cli::cli_abort(c("x" = "Error message", "i" = "Context/Hint"))</code> - <strong>Why:</strong> Structured errors are easier to debug and present better to users.</p>
</div>
<div class="section level2">
<h2 id="agents">Agents<a class="anchor" aria-label="anchor" href="#agents"></a></h2>
<p><strong>Delegation saves context</strong>: Subagents keep verbose output in their context, returning only summaries to the main conversation.</p>
<div class="section level3">
<h3 id="common-agents">Common Agents<a class="anchor" aria-label="anchor" href="#common-agents"></a></h3>
<table class="table"><colgroup><col width="33%"><col width="33%"><col width="33%"></colgroup><thead><tr><th>Agent</th>
<th>Model</th>
<th>Use For</th>
</tr></thead><tbody><tr><td><code>general-purpose</code></td>
<td>opus/sonnet/haiku</td>
<td>General tasks (specify model based on complexity)</td>
</tr><tr><td><code>verbose-runner</code></td>
<td>sonnet</td>
<td>Tests, checks, builds with verbose output</td>
</tr><tr><td><code>r-debugger</code></td>
<td>sonnet</td>
<td>R CMD check/test failures</td>
</tr><tr><td><code>reviewer</code></td>
<td>sonnet</td>
<td>Code reviews</td>
</tr><tr><td><code>nix-env</code></td>
<td>sonnet</td>
<td>Nix shell issues</td>
</tr><tr><td><code>targets-runner</code></td>
<td>sonnet</td>
<td>Pipeline debugging</td>
</tr><tr><td><code>shinylive-builder</code></td>
<td>sonnet</td>
<td>WASM builds</td>
</tr><tr><td><code>data-engineer</code></td>
<td>sonnet</td>
<td>Pipeline building (dbt/DuckDB)</td>
</tr><tr><td><code>data-quality-guardian</code></td>
<td>sonnet</td>
<td>Data validation (pointblank)</td>
</tr><tr><td><code>claude-code-guide</code></td>
<td>sonnet</td>
<td>Claude Code documentation lookup</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="mandatory-agent-usage-rules-critical---no-exceptions">MANDATORY Agent Usage Rules (CRITICAL - NO EXCEPTIONS)<a class="anchor" aria-label="anchor" href="#mandatory-agent-usage-rules-critical---no-exceptions"></a></h3>
<div class="section level4">
<h4 id="id_1-always-use-cheaper-models-where-possible">1. Always Use Cheaper Models Where Possible<a class="anchor" aria-label="anchor" href="#id_1-always-use-cheaper-models-where-possible"></a></h4>
<p><strong>❌ WRONG:</strong> Using Opus for simple tasks (wastes tokens and money)</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>Task(subagent_type<span class="op">=</span><span class="st">"general-purpose"</span>, prompt<span class="op">=</span><span class="st">"check if file exists"</span>)  <span class="co"># Defaults to Opus!</span></span></code></pre></div>
<p><strong>✅ CORRECT:</strong> Match model to task complexity</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a>Task(subagent_type<span class="op">=</span><span class="st">"general-purpose"</span>, model<span class="op">=</span><span class="st">"haiku"</span>, prompt<span class="op">=</span><span class="st">"check if file exists"</span>)  <span class="co"># Simple task</span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a>Task(subagent_type<span class="op">=</span><span class="st">"verbose-runner"</span>, model<span class="op">=</span><span class="st">"sonnet"</span>, prompt<span class="op">=</span><span class="st">"run test suite"</span>)  <span class="co"># Medium complexity</span></span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a>Task(subagent_type<span class="op">=</span><span class="st">"planner"</span>, model<span class="op">=</span><span class="st">"opus"</span>, prompt<span class="op">=</span><span class="st">"design architecture"</span>)  <span class="co"># Complex reasoning</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="id_2-run-independent-tasks-in-parallel">2. Run Independent Tasks in Parallel<a class="anchor" aria-label="anchor" href="#id_2-run-independent-tasks-in-parallel"></a></h4>
<p>Execute independent tasks simultaneously for efficiency:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="co"># ✅ CORRECT - All run simultaneously</span></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>Task(model<span class="op">=</span><span class="st">"haiku"</span>, prompt<span class="op">=</span><span class="st">"check logs"</span>),</span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a>Task(model<span class="op">=</span><span class="st">"haiku"</span>, prompt<span class="op">=</span><span class="st">"check status"</span>),</span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a>Task(model<span class="op">=</span><span class="st">"haiku"</span>, prompt<span class="op">=</span><span class="st">"test endpoint"</span>)</span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a><span class="co"># ❌ WRONG - Sequential (slow)</span></span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a>Task(prompt<span class="op">=</span><span class="st">"check logs"</span>)     <span class="co"># Waits...</span></span>
<span id="cb30-8"><a href="#cb30-8" tabindex="-1"></a>Task(prompt<span class="op">=</span><span class="st">"check status"</span>)   <span class="co"># Then waits...</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="model-selection-guide-mandatory">Model Selection Guide (MANDATORY)<a class="anchor" aria-label="anchor" href="#model-selection-guide-mandatory"></a></h3>
<table class="table"><colgroup><col width="25%"><col width="25%"><col width="25%"><col width="25%"></colgroup><thead><tr><th>Task Type</th>
<th>Model</th>
<th>Cost</th>
<th>Examples</th>
</tr></thead><tbody><tr><td>Simple queries</td>
<td><code>haiku</code></td>
<td>$</td>
<td>File checks, curl, grep, counting</td>
</tr><tr><td>Moderate work</td>
<td><code>sonnet</code></td>
<td>$$ | Tests, debugging, analysis | | Complex reasoning | `opus` | $$$</td>
<td>Architecture, planning, multi-file</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="when-to-delegate">When to Delegate<a class="anchor" aria-label="anchor" href="#when-to-delegate"></a></h3>
<p><strong>Core rule:</strong> Delegate when output &gt; 10 lines OR complex reasoning needed <strong>Never delegate:</strong> Simple file checks (ls, cat), one-line commands, reading files</p>
<p><strong>Common mistakes to avoid:</strong> - Using agents to check symlinks exist (just use <code>ls -la</code>) - Using btw tools directly for builds/tests (always delegate) - Using wrong agent for task (e.g., haiku for complex verification) - Not running independent tasks in parallel - Using expensive models (opus) for simple tasks</p>
<p>For detailed rules → invoke <code>subagent-delegation</code> skill</p>
</div>
</div>
<div class="section level2">
<h2 id="skills">Skills<a class="anchor" aria-label="anchor" href="#skills"></a></h2>
<p><strong>Key skills available:</strong> - <code>adversarial-qa</code> - MANDATORY: Attack-based testing for exported functions (Step 4) - <code>quality-gates</code> - MANDATORY: Numeric scoring for commit/PR/merge gates (Step 4) - <code>readme-qmd-standard</code> - README.qmd template and requirements - <code>subagent-delegation</code> - When and how to delegate to agents</p>
<p><strong>Note:</strong> Additional skills may be available. Check <code>/Users/johngavin/.claude/skills/</code> for full list.</p>
</div>
<div class="section level2">
<h2 id="common-tasks">Common Tasks<a class="anchor" aria-label="anchor" href="#common-tasks"></a></h2>
<table class="table"><colgroup><col width="50%"><col width="50%"></colgroup><thead><tr><th>Task</th>
<th>Approach</th>
</tr></thead><tbody><tr><td>Need package API docs</td>
<td>Use <code>nix run github:b-rodrigues/pkgctx</code>
</td>
</tr><tr><td>Writing GitHub Actions</td>
<td>Check <code>.github/workflows/</code> for examples</td>
</tr><tr><td>Debugging R errors</td>
<td>Use <code>r-debugger</code> agent</td>
</tr><tr><td>Testing Shiny dashboards</td>
<td>Use <code>--chrome</code> option to launch Claude with browser</td>
</tr><tr><td>README requirements</td>
<td>Load <code>readme-qmd-standard</code> skill</td>
</tr><tr><td>Agent delegation</td>
<td>Load <code>subagent-delegation</code> skill</td>
</tr></tbody></table></div>
<div class="section level2">
<h2 id="testing-shiny-apps">Testing Shiny Apps<a class="anchor" aria-label="anchor" href="#testing-shiny-apps"></a></h2>
<p><strong>With Chrome Extension:</strong></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="co"># Launch Claude with Chrome extension</span></span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a><span class="ex">claude</span> <span class="at">--chrome</span></span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a><span class="co"># Then in R:</span></span>
<span id="cb31-5"><a href="#cb31-5" tabindex="-1"></a><span class="fu">launch_dashboard()</span>  <span class="co"># Can interact with browser</span></span></code></pre></div>
<p><strong>Without Chrome Extension:</strong> - Only verify functions exist - Don’t actually launch (will hang waiting for browser)</p>
</div>
<div class="section level2">
<h2 id="custom-commands">Custom Commands<a class="anchor" aria-label="anchor" href="#custom-commands"></a></h2>
<ul><li>
<code>/session-start</code> - Initialize session</li>
<li>
<code>/session-end</code> - End session (commit, push)</li>
<li>
<code>/check</code> - Run document(), test(), check()</li>
<li>
<code>/pr-status</code> - Check PR and CI status</li>
<li>
<code>/cleanup</code> - Review and simplify work</li>
</ul></div>
<div class="section level2">
<h2 id="file-structure-critical">File Structure (CRITICAL)<a class="anchor" aria-label="anchor" href="#file-structure-critical"></a></h2>
<div class="sourceCode" id="cb32"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a>R<span class="sc">/</span>                    <span class="co"># Package functions ONLY</span></span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a>├── <span class="sc">*</span>.R               <span class="co"># Analysis functions</span></span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a>├── dev<span class="sc">/</span>              <span class="co"># Development tools</span></span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a>│   └── issues<span class="sc">/</span>       <span class="co"># Fix scripts (MUST include in PRs)</span></span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a>└── tar_plans<span class="sc">/</span>        <span class="co"># Modular pipeline components (MANDATORY)</span></span>
<span id="cb32-6"><a href="#cb32-6" tabindex="-1"></a>    └── plan_<span class="sc">*</span>.R      <span class="co"># Each returns list of tar_target()</span></span>
<span id="cb32-7"><a href="#cb32-7" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" tabindex="-1"></a>_targets.R            <span class="co"># ONLY orchestrates plans from R/tar_plans/</span></span>
<span id="cb32-9"><a href="#cb32-9" tabindex="-1"></a>vignettes<span class="sc">/</span>            <span class="co"># Quarto documentation</span></span>
<span id="cb32-10"><a href="#cb32-10" tabindex="-1"></a>plans<span class="sc">/</span>                <span class="co"># PLAN_*.md working documents</span></span>
<span id="cb32-11"><a href="#cb32-11" tabindex="-1"></a>README.qmd            <span class="co"># Source for README.md (NEVER edit README.md directly)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="readme-requirements-mandatory">README Requirements (MANDATORY)<a class="anchor" aria-label="anchor" href="#readme-requirements-mandatory"></a></h2>
<p><strong>Every project MUST include Nix installation instructions in README:</strong></p>
<ol style="list-style-type: decimal"><li>
<strong>Use README.qmd as source</strong> - Never edit README.md directly</li>
<li>
<strong>Include THREE installation methods:</strong>
<ul><li>Standard R (remotes/devtools)</li>
<li><strong>Nix with default.sh method (CRITICAL)</strong></li>
<li>rix integration example (MUST specify commit SHA for git_pkgs)</li>
</ul></li>
<li>
<strong>Auto-generate project structure</strong> using fs::dir_tree()</li>
<li>
<strong>Create targets plan</strong> for auto-regenerating README on vignette changes</li>
<li>
<strong>TEST ALL CODE EXAMPLES</strong> - Every code chunk in README.md must be tested as part of Step 4 in 9-step workflow</li>
</ol><p>See <code>readme-qmd-standard</code> skill for complete template.</p>
<div class="section level3">
<h3 id="documentation-pipeline-mandatory">Documentation Pipeline (MANDATORY)<a class="anchor" aria-label="anchor" href="#documentation-pipeline-mandatory"></a></h3>
<p><strong>Use targets for reproducible documentation:</strong> - Pre-compute vignette data in Nix environment - Save results to inst/extdata/ - Vignettes load pre-computed data (never compute on-the-fly) - This ensures CI can render docs without package installation</p>
</div>
<div class="section level3">
<h3 id="code-examples-as-targets-mandatory">Code Examples as Targets (MANDATORY)<a class="anchor" aria-label="anchor" href="#code-examples-as-targets-mandatory"></a></h3>
<p><strong>All code examples in README.qmd and vignettes MUST be stored as targets:</strong></p>
<ol style="list-style-type: decimal"><li>
<p><strong>Define <code>parse_code_example()</code> helper</strong> in <code>R/tar_plans/plan_doc_examples.R</code>:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">parse_code_example</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">code_lines</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">code_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">code_lines</span>, collapse <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>    <span class="op">{</span> <span class="va">parsed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">code_text</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>valid <span class="op">=</span> <span class="cn">TRUE</span>, n_expressions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">parsed</span><span class="op">)</span>,</span>
<span>           code <span class="op">=</span> <span class="va">code_lines</span>, error <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">}</span>,</span>
<span>    error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>valid <span class="op">=</span> <span class="cn">FALSE</span>, n_expressions <span class="op">=</span> <span class="fl">0L</span>,</span>
<span>           code <span class="op">=</span> <span class="va">code_lines</span>, error <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">conditionMessage</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</li>
<li>
<p><strong>Store code as text</strong> targets:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>  <span class="va">code_example_query</span>,</span>
<span>  <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/force.html" class="external-link">force</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="st">"R/database_parquet.R"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"# Example: Query data"</span>,</span>
<span>      <span class="st">"result &lt;- query_data(con, table = 'my_table')"</span>,</span>
<span>      <span class="st">"head(result)"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Parse to validate syntax</strong>:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>  <span class="va">code_parsed_query</span>,</span>
<span>  <span class="fu">parse_code_example</span><span class="op">(</span><span class="va">code_example_query</span><span class="op">)</span>  <span class="co"># Returns list(valid, error, code)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Evaluate with mock data</strong> (optional – parse validation is the minimum):</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>  <span class="va">code_eval_query</span>,</span>
<span>  <span class="fu">eval_code_with_mock_db</span><span class="op">(</span><span class="va">code_example_query</span><span class="op">)</span>  <span class="co"># Returns list(success, error)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Display in .qmd vignettes</strong>:</p>
<pre class="qmd"><code>```{r}
#| echo: false
#| results: asis
targets::tar_load(code_example_query)
cat("```r\n", paste(code_example_query, collapse = "\n"), "\n```", sep = "")
```</code></pre>
</li>
<li>
<p><strong>Display in .Rmd vignettes</strong> (hidden by default with <code>&lt;details&gt;</code>):</p>
<pre class="rmd"><code>```{r code-example, results='asis'}
code &lt;- safe_tar_read("code_example_query")
if (!is.null(code)) {
  cat("&lt;details&gt;\n&lt;summary&gt;Show code&lt;/summary&gt;\n\n```r\n")
  cat(paste(code, collapse = "\n"))
  cat("\n```\n&lt;/details&gt;\n")
} else {
  cat("*Code example not available. Run `tar_make()` first.*\n")
}
```</code></pre>
</li>
<li>
<p><strong>Validation gate</strong> to fail pipeline if syntax errors:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>  <span class="va">doc_examples_validation</span>,</span>
<span>  <span class="op">{</span></span>
<span>    <span class="va">parse_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">code_parsed_query</span>, <span class="va">...</span><span class="op">)</span></span>
<span>    <span class="va">all_valid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">parse_results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">valid</span>, <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">all_valid</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">failed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">parse_results</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">parse_results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">valid</span>, <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span>      <span class="fu">cli</span><span class="fu">::</span><span class="fu"><a href="https://cli.r-lib.org/reference/cli_abort.html" class="external-link">cli_abort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span> <span class="op">=</span> <span class="st">"Code examples failed syntax validation"</span>,</span>
<span>                       <span class="st">"i"</span> <span class="op">=</span> <span class="st">"Failed: {paste(failed, collapse = ', ')}"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>all_valid <span class="op">=</span> <span class="va">all_valid</span>, n_examples <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">parse_results</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
</li>
</ol><p><strong>Why this pattern:</strong> - <strong>Tested examples</strong>: Pipeline fails if code has syntax errors - <strong>Single source of truth</strong>: Code defined once, displayed in multiple places - <strong>DRY</strong>: No copy-paste between README and vignettes - <strong>Always provide tidyverse alternative</strong>: After SQL examples, show dplyr/duckplyr equivalent - <strong>Order extreme data by the extreme column</strong>: e.g., <code>ORDER BY hmax DESC</code> not <code>ORDER BY time DESC</code></p>
<p><strong>Reference implementations:</strong> - <code>irishbuoys/R/tar_plans/plan_doc_examples.R</code> (15 code targets, 468 LOC) - <code>coMMpass/R/tar_plans/plan_doc_examples.R</code> (4 code targets)</p>
</div>
<div class="section level3">
<h3 id="readme-project-structure-mandatory">README Project Structure (MANDATORY)<a class="anchor" aria-label="anchor" href="#readme-project-structure-mandatory"></a></h3>
<p><strong>Always use <code>fs::dir_tree(recurse = 2)</code> in README:</strong></p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a><span class="st">```</span><span class="at">{r}</span></span>
<span id="cb40-2"><a href="#cb40-2" tabindex="-1"></a><span class="at">#| echo: false</span></span>
<span id="cb40-3"><a href="#cb40-3" tabindex="-1"></a><span class="at">#| eval: true</span></span>
<span id="cb40-4"><a href="#cb40-4" tabindex="-1"></a><span class="at">fs::dir_tree(recurse = 2)</span></span></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a><span class="sc">**</span>Why<span class="sc">:</span><span class="er">**</span> Full recursion shows hundreds of files <span class="cf">in</span> deps<span class="sc">/</span>, <span class="sc">*</span>_files<span class="sc">/</span>, etc. Limit to <span class="dv">2</span> levels <span class="cf">for</span> readability.</span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" tabindex="-1"></a><span class="do">### Data Files (MANDATORY)</span></span>
<span id="cb41-4"><a href="#cb41-4" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" tabindex="-1"></a><span class="sc">**</span>Prefer compressed formats<span class="sc">:</span><span class="er">**</span></span>
<span id="cb41-6"><a href="#cb41-6" tabindex="-1"></a><span class="sc">-</span> <span class="st">`</span><span class="at">.parquet</span><span class="st">`</span> over <span class="st">`</span><span class="at">.csv</span><span class="st">`</span> (<span class="dv">10-50</span>x smaller, typed columns)</span>
<span id="cb41-7"><a href="#cb41-7" tabindex="-1"></a><span class="sc">-</span> <span class="st">`</span><span class="at">.csv.gz</span><span class="st">`</span> or <span class="st">`</span><span class="at">.json.gz</span><span class="st">`</span> <span class="cf">if</span> text format required</span>
<span id="cb41-8"><a href="#cb41-8" tabindex="-1"></a><span class="sc">-</span> Never commit large uncompressed data files</span>
<span id="cb41-9"><a href="#cb41-9" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" tabindex="-1"></a><span class="sc">**</span>For dashboards fetching data<span class="sc">:</span><span class="er">**</span></span>
<span id="cb41-11"><a href="#cb41-11" tabindex="-1"></a><span class="sc">-</span> Use parquet via JavaScript <span class="fu">fetch</span>() <span class="cf">for</span> browser dashboards</span>
<span id="cb41-12"><a href="#cb41-12" tabindex="-1"></a><span class="sc">-</span> Sample data <span class="cf">for</span> interactive <span class="fu">widgets</span> (<span class="dv">10</span>K rows max)</span>
<span id="cb41-13"><a href="#cb41-13" tabindex="-1"></a><span class="sc">-</span> Pre<span class="sc">-</span>aggregate where possible</span>
<span id="cb41-14"><a href="#cb41-14" tabindex="-1"></a></span>
<span id="cb41-15"><a href="#cb41-15" tabindex="-1"></a><span class="do">### Code Display Best Practices (MANDATORY)</span></span>
<span id="cb41-16"><a href="#cb41-16" tabindex="-1"></a></span>
<span id="cb41-17"><a href="#cb41-17" tabindex="-1"></a><span class="sc">**</span>NEVER show code with prompts or console output markers<span class="sc">:</span><span class="er">**</span></span>
<span id="cb41-18"><a href="#cb41-18" tabindex="-1"></a><span class="sc">-</span> ❌ WRONG<span class="sc">:</span> <span class="st">`</span><span class="at">&gt; library(millsratio)</span><span class="st">`</span> <span class="sc">-</span> Cannot copy<span class="sc">/</span>paste</span>
<span id="cb41-19"><a href="#cb41-19" tabindex="-1"></a><span class="sc">-</span> ✅ RIGHT<span class="sc">:</span> <span class="st">`</span><span class="at">library(millsratio)</span><span class="st">`</span> <span class="sc">-</span> Clean, copyable code</span>
<span id="cb41-20"><a href="#cb41-20" tabindex="-1"></a></span>
<span id="cb41-21"><a href="#cb41-21" tabindex="-1"></a><span class="sc">**</span>In vignettes<span class="sc">/</span>examples, NEVER use<span class="sc">:</span><span class="er">**</span></span>
<span id="cb41-22"><a href="#cb41-22" tabindex="-1"></a><span class="sc">-</span> ❌ <span class="st">`</span><span class="at">devtools::load_all()</span><span class="st">`</span> <span class="sc">-</span> Assumes devtools is installed</span>
<span id="cb41-23"><a href="#cb41-23" tabindex="-1"></a><span class="sc">-</span> ✅ <span class="st">`</span><span class="at">library(package_name)</span><span class="st">`</span> <span class="sc">-</span> Standard package loading</span>
<span id="cb41-24"><a href="#cb41-24" tabindex="-1"></a></span>
<span id="cb41-25"><a href="#cb41-25" tabindex="-1"></a><span class="sc">**</span>Why<span class="sc">:</span><span class="er">**</span> Users copy<span class="sc">/</span>paste code directly. Prompts and dev functions <span class="cf">break</span> their workflow.</span>
<span id="cb41-26"><a href="#cb41-26" tabindex="-1"></a></span>
<span id="cb41-27"><a href="#cb41-27" tabindex="-1"></a><span class="do">### Targets Pipeline Structure (MANDATORY)</span></span>
<span id="cb41-28"><a href="#cb41-28" tabindex="-1"></a></span>
<span id="cb41-29"><a href="#cb41-29" tabindex="-1"></a><span class="sc">**</span>NEVER place pipeline definitions directly <span class="cf">in</span> _targets.R<span class="sc">**</span></span>
<span id="cb41-30"><a href="#cb41-30" tabindex="-1"></a></span>
<span id="cb41-31"><a href="#cb41-31" tabindex="-1"></a><span class="er">**</span>Correct Structure<span class="sc">:</span><span class="er">**</span></span>
<span id="cb41-32"><a href="#cb41-32" tabindex="-1"></a><span class="fl">1.</span> <span class="sc">**</span>R<span class="sc">/</span>tar_plans<span class="sc">/</span>plan_<span class="sc">*</span>.R<span class="sc">**</span><span class="er">:</span> Modular pipeline components</span>
<span id="cb41-33"><a href="#cb41-33" tabindex="-1"></a>   <span class="sc">-</span> Each file defines one logical <span class="fu">group</span> (e.g., plan_data_acquisition.R)</span>
<span id="cb41-34"><a href="#cb41-34" tabindex="-1"></a>   <span class="sc">-</span> Must return a list of <span class="fu">tar_target</span>() objects</span>
<span id="cb41-35"><a href="#cb41-35" tabindex="-1"></a>   <span class="sc">-</span> Example<span class="sc">:</span> plan_data_acquisition, plan_quality_control</span>
<span id="cb41-36"><a href="#cb41-36" tabindex="-1"></a></span>
<span id="cb41-37"><a href="#cb41-37" tabindex="-1"></a><span class="fl">2.</span> <span class="sc">**</span>_targets.R<span class="sc">**</span><span class="er">:</span> Orchestrator ONLY</span>
<span id="cb41-38"><a href="#cb41-38" tabindex="-1"></a>   <span class="st">```</span><span class="at">r</span></span>
<span id="cb41-39"><a href="#cb41-39" tabindex="-1"></a><span class="at">   # Set global options</span></span>
<span id="cb41-40"><a href="#cb41-40" tabindex="-1"></a><span class="at">   tar_option_set(...)</span></span>
<span id="cb41-41"><a href="#cb41-41" tabindex="-1"></a></span>
<span id="cb41-42"><a href="#cb41-42" tabindex="-1"></a><span class="at">   # Source functions (exclude R/dev/ and R/tar_plans/)</span></span>
<span id="cb41-43"><a href="#cb41-43" tabindex="-1"></a><span class="at">   for (file in list.files("R", pattern = "</span><span class="sc">\\</span><span class="at">.R$", full.names = TRUE)) {</span></span>
<span id="cb41-44"><a href="#cb41-44" tabindex="-1"></a><span class="at">     if (!grepl("R/(dev|tar_plans)/", file)) source(file)</span></span>
<span id="cb41-45"><a href="#cb41-45" tabindex="-1"></a><span class="at">   }</span></span>
<span id="cb41-46"><a href="#cb41-46" tabindex="-1"></a></span>
<span id="cb41-47"><a href="#cb41-47" tabindex="-1"></a><span class="at">   # Source and combine plans</span></span>
<span id="cb41-48"><a href="#cb41-48" tabindex="-1"></a><span class="at">   plan_files &lt;- list.files("R/tar_plans", pattern = "^plan_.*</span><span class="sc">\\</span><span class="at">.R$", full.names = TRUE)</span></span>
<span id="cb41-49"><a href="#cb41-49" tabindex="-1"></a><span class="at">   for (plan_file in plan_files) source(plan_file)</span></span>
<span id="cb41-50"><a href="#cb41-50" tabindex="-1"></a></span>
<span id="cb41-51"><a href="#cb41-51" tabindex="-1"></a><span class="at">   # Combine all plans</span></span>
<span id="cb41-52"><a href="#cb41-52" tabindex="-1"></a><span class="at">   c(plan_data_acquisition, plan_quality_control, ...)</span></span></code></pre></div>
<p><strong>Why This Matters:</strong> - <strong>Modularity</strong>: Plans can be reused across projects - <strong>Testing</strong>: Individual plans can be tested in isolation - <strong>Collaboration</strong>: Multiple developers can work on different plans - <strong>Reproducibility</strong>: Clear separation of concerns</p>
</div>
</div>
<div class="section level2">
<h2 id="two-tier-nix-shell-architecture-critical-for-agents">Two-Tier Nix Shell Architecture (CRITICAL FOR AGENTS)<a class="anchor" aria-label="anchor" href="#two-tier-nix-shell-architecture-critical-for-agents"></a></h2>
<p>Claude and its agents operate in a <strong>two-tier Nix shell architecture</strong>:</p>
<table class="table"><colgroup><col width="25%"><col width="25%"><col width="25%"><col width="25%"></colgroup><thead><tr><th>Shell</th>
<th>Purpose</th>
<th>Started By</th>
<th>Has Project Packages?</th>
</tr></thead><tbody><tr><td><strong>Development shell</strong></td>
<td>Generic R dev tools for all projects</td>
<td>
<code>caffeinate -i ~/docs_gh/rix.setup/default.sh</code> on session start</td>
<td>❌ No - only base tools</td>
</tr><tr><td><strong>Project-specific shell</strong></td>
<td>All packages from project’s DESCRIPTION</td>
<td>
<code>nix-shell default.nix</code> in project root</td>
<td>✅ Yes</td>
</tr></tbody></table><div class="section level3">
<h3 id="how-agents-run-project-specific-commands">How Agents Run Project-Specific Commands<a class="anchor" aria-label="anchor" href="#how-agents-run-project-specific-commands"></a></h3>
<p>Agents run in the development shell by default. To run commands that need project packages (from DESCRIPTION), use <code>nix-shell --run</code>:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a><span class="co"># Pattern: nix-shell default.nix --run "COMMAND"</span></span>
<span id="cb42-2"><a href="#cb42-2" tabindex="-1"></a><span class="bu">cd</span> /path/to/project</span>
<span id="cb42-3"><a href="#cb42-3" tabindex="-1"></a><span class="ex">nix-shell</span> default.nix <span class="at">--run</span> <span class="st">"Rscript -e 'devtools::document()'"</span></span>
<span id="cb42-4"><a href="#cb42-4" tabindex="-1"></a><span class="ex">nix-shell</span> default.nix <span class="at">--run</span> <span class="st">"Rscript -e 'devtools::test()'"</span></span>
<span id="cb42-5"><a href="#cb42-5" tabindex="-1"></a><span class="ex">nix-shell</span> default.nix <span class="at">--run</span> <span class="st">"Rscript -e 'devtools::check()'"</span></span></code></pre></div>
<p><strong>Why this works:</strong> - <code>nix-shell --run</code> enters the project shell, runs the command, then exits - Non-interactive - agents can use this - All packages from DESCRIPTION are available</p>
<p><strong>DO NOT use <code>./default.sh</code></strong> - it spawns an interactive shell that agents cannot control.</p>
</div>
<div class="section level3">
<h3 id="what-agents-can-do">What Agents CAN Do<a class="anchor" aria-label="anchor" href="#what-agents-can-do"></a></h3>
<table class="table"><colgroup><col width="33%"><col width="33%"><col width="33%"></colgroup><thead><tr><th>Task</th>
<th>Method</th>
<th>Notes</th>
</tr></thead><tbody><tr><td>Edit/Read files</td>
<td>Direct tools</td>
<td>No R packages needed</td>
</tr><tr><td>devtools::document/test/check</td>
<td><code>nix-shell default.nix --run "..."</code></td>
<td>All project packages available</td>
</tr><tr><td>Run targets pipeline</td>
<td><code>nix-shell default.nix --run "Rscript -e 'targets::tar_make()'"</code></td>
<td>Needs project packages</td>
</tr><tr><td>Git operations</td>
<td>gert/Bash</td>
<td>gert is in dev shell</td>
</tr><tr><td>Simple R code</td>
<td>btw tools</td>
<td>Only if packages are in dev shell</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="example-running-check">Example: Running /check<a class="anchor" aria-label="anchor" href="#example-running-check"></a></h3>
<div class="sourceCode" id="cb43"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a><span class="bu">cd</span> /path/to/project</span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" tabindex="-1"></a><span class="co"># Document</span></span>
<span id="cb43-4"><a href="#cb43-4" tabindex="-1"></a><span class="ex">nix-shell</span> default.nix <span class="at">--run</span> <span class="st">"Rscript -e 'devtools::document()'"</span></span>
<span id="cb43-5"><a href="#cb43-5" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" tabindex="-1"></a><span class="co"># Test</span></span>
<span id="cb43-7"><a href="#cb43-7" tabindex="-1"></a><span class="ex">nix-shell</span> default.nix <span class="at">--run</span> <span class="st">"Rscript -e 'devtools::test()'"</span></span>
<span id="cb43-8"><a href="#cb43-8" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" tabindex="-1"></a><span class="co"># Check</span></span>
<span id="cb43-10"><a href="#cb43-10" tabindex="-1"></a><span class="ex">nix-shell</span> default.nix <span class="at">--run</span> <span class="st">"Rscript -e 'devtools::check(args = </span><span class="dt">\"</span><span class="st">--as-cran</span><span class="dt">\"</span><span class="st">)'"</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="btw-mcp-tool-configuration">btw MCP Tool Configuration<a class="anchor" aria-label="anchor" href="#btw-mcp-tool-configuration"></a></h2>
<p><strong>Current subset</strong> (saves ~6k tokens vs all tools): <code>btw::btw_tools(c('docs', 'pkg', 'files', 'run', 'env', 'session'))</code></p>
<table class="table"><thead><tr><th>Loaded</th>
<th>Category</th>
<th>Purpose</th>
</tr></thead><tbody><tr><td>✓</td>
<td>docs</td>
<td>R help pages, vignettes, NEWS</td>
</tr><tr><td>✓</td>
<td>pkg</td>
<td>check, test, document, coverage</td>
</tr><tr><td>✓</td>
<td>files</td>
<td>read, write, list, search</td>
</tr><tr><td>✓</td>
<td>run</td>
<td>execute R code</td>
</tr><tr><td>✓</td>
<td>env</td>
<td>describe data frames, environment</td>
</tr><tr><td>✓</td>
<td>session</td>
<td>platform info, package versions</td>
</tr></tbody></table><p><strong>CRITICAL DELEGATION RULE FOR BTW TOOLS:</strong></p>
<div class="section level3">
<h3 id="warning-mandatory-no-infinite-waits--timeouts-required-everywhere">⚠️ MANDATORY: No Infinite Waits — Timeouts Required Everywhere<a class="anchor" aria-label="anchor" href="#warning-mandatory-no-infinite-waits--timeouts-required-everywhere"></a></h3>
<p><strong>Blocking indefinitely is STRICTLY FORBIDDEN.</strong> This applies to ALL tools, agents, and commands — not just btw tools. Any operation that could run longer than ~30 seconds MUST either:</p>
<ol style="list-style-type: decimal"><li>
<strong>Use a timeout</strong> (Bash <code>timeout</code> parameter, or wrap with <code>timeout</code> command)</li>
<li>
<strong>Run in background</strong> (<code>run_in_background: true</code>) and check status non-blocking</li>
<li>
<strong>Delegate to a subagent</strong> (which has its own <code>max_turns</code> limit)</li>
</ol><p><strong>Common violations (ALL FORBIDDEN):</strong> - <code>gh run watch</code> — blocks until CI finishes (10–30+ min) - <code>btw_tool_run_r</code> with long-running code — has NO built-in timeout - <code>btw_tool_pkg_check</code> / <code>btw_tool_pkg_test</code> — can run for minutes - <code>nix-build</code> without timeout — can take 30+ min on cache miss - Any <code>Bash</code> call without explicit <code>timeout</code> on commands &gt; 30s - <code>shiny::runApp()</code> or <code>launch_dashboard()</code> — blocks forever (waits for browser) - Any function that waits for user input or network response</p>
<p><strong>Correct patterns:</strong></p>
<div class="sourceCode" id="cb44"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a><span class="co"># ❌ WRONG — blocks for 10+ min</span></span>
<span id="cb44-2"><a href="#cb44-2" tabindex="-1"></a><span class="ex">gh</span> run watch 12345 <span class="at">--exit-status</span></span>
<span id="cb44-3"><a href="#cb44-3" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" tabindex="-1"></a><span class="co"># ✅ CORRECT — non-blocking status check</span></span>
<span id="cb44-5"><a href="#cb44-5" tabindex="-1"></a><span class="ex">gh</span> run view 12345 <span class="at">--json</span> status,conclusion</span>
<span id="cb44-6"><a href="#cb44-6" tabindex="-1"></a></span>
<span id="cb44-7"><a href="#cb44-7" tabindex="-1"></a><span class="co"># ❌ WRONG — no timeout on slow build</span></span>
<span id="cb44-8"><a href="#cb44-8" tabindex="-1"></a><span class="ex">nix-build</span> default.nix</span>
<span id="cb44-9"><a href="#cb44-9" tabindex="-1"></a></span>
<span id="cb44-10"><a href="#cb44-10" tabindex="-1"></a><span class="co"># ✅ CORRECT — delegate to subagent OR use background</span></span>
<span id="cb44-11"><a href="#cb44-11" tabindex="-1"></a><span class="ex">Task</span><span class="er">(</span><span class="va">subagent_type</span><span class="op">=</span><span class="st">"Bash"</span>, <span class="va">prompt</span><span class="op">=</span><span class="st">"nix-build default.nix"</span><span class="kw">)</span></span>
<span id="cb44-12"><a href="#cb44-12" tabindex="-1"></a></span>
<span id="cb44-13"><a href="#cb44-13" tabindex="-1"></a><span class="co"># ❌ WRONG — btw_tool_run_r with devtools::check()</span></span>
<span id="cb44-14"><a href="#cb44-14" tabindex="-1"></a><span class="ex">btw_tool_run_r</span><span class="er">(</span><span class="ex">code</span> = <span class="st">"devtools::check()"</span><span class="kw">)</span></span>
<span id="cb44-15"><a href="#cb44-15" tabindex="-1"></a></span>
<span id="cb44-16"><a href="#cb44-16" tabindex="-1"></a><span class="co"># ✅ CORRECT — delegate to subagent</span></span>
<span id="cb44-17"><a href="#cb44-17" tabindex="-1"></a><span class="ex">Task</span><span class="er">(</span><span class="va">subagent_type</span><span class="op">=</span><span class="st">"Bash"</span>, <span class="va">model</span><span class="op">=</span><span class="st">"sonnet"</span>, <span class="va">prompt</span><span class="op">=</span><span class="st">"run devtools::check()"</span><span class="kw">)</span></span></code></pre></div>
<p><strong>NEVER call btw_tool_run_r directly for:</strong> - devtools::test(), check(), build() → Use agent with <code>model="sonnet"</code> - Any gh::gh() API calls that might hang → Use <code>Bash</code> with timeout - Any operation expecting &gt;10 lines output → Use agent with <code>model="sonnet"</code> - Debugging test failures → Use <code>r-debugger</code> agent</p>
<p><strong>NEVER call btw_tool_pkg_* directly</strong> → Always use appropriate agent</p>
<p><strong>Key principle:</strong> Run independent tasks in parallel with appropriate models (see Agent Usage Rules above)</p>
<p><strong>Exception:</strong> Simple one-liners (&lt;5s), checking values, quick calculations</p>
<table class="table"><colgroup><col width="33%"><col width="33%"><col width="33%"></colgroup><thead><tr><th>Excluded</th>
<th>Why</th>
<th>Alternative</th>
</tr></thead><tbody><tr><td>git</td>
<td>Use <code>gert::git_*()</code> per 9-step workflow</td>
<td>gert R package</td>
</tr><tr><td>github</td>
<td>Use <a href="https://gh.r-lib.org/reference/gh.html" class="external-link"><code>gh::gh()</code></a> per 9-step workflow</td>
<td>gh R package</td>
</tr><tr><td>agents</td>
<td>Redundant - Task tool has same agents</td>
<td>Task tool subagents</td>
</tr><tr><td>cran</td>
<td>Rarely needed for active dev</td>
<td>WebSearch</td>
</tr><tr><td>web</td>
<td>Redundant</td>
<td>WebFetch tool</td>
</tr><tr><td>ide</td>
<td>Rarely used</td>
<td>-</td>
</tr></tbody></table><p><strong>Re-enable if needed:</strong> Edit <code>~/.claude.json</code> mcpServers args: - Add <code>'git'</code> if gert isn’t working - Add <code>'github'</code> if gh::gh() fails - Add <code>'cran'</code> when searching for new packages</p>
</div>
</div>
<div class="section level2">
<h2 id="shinylivewebr-critical-rules-must-read">Shinylive/WebR Critical Rules (MUST READ)<a class="anchor" aria-label="anchor" href="#shinylivewebr-critical-rules-must-read"></a></h2>
<div class="section level3">
<h3 id="warning-the-munsell-problem---recurring-issue">⚠️ THE MUNSELL PROBLEM - RECURRING ISSUE<a class="anchor" aria-label="anchor" href="#warning-the-munsell-problem---recurring-issue"></a></h3>
<p><strong>CRITICAL:</strong> The ggplot2/munsell error in Shinylive/WebR is a <strong>PERSISTENT RECURRING ISSUE</strong> that keeps coming back!</p>
<p><strong>The Error:</strong></p>
<div class="sourceCode" id="cb45"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a>preload error<span class="sc">:</span> there is no package called <span class="st">'munsell'</span></span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a>preload error<span class="sc">:</span> Error<span class="sc">:</span> package <span class="st">'ggplot2'</span> could not be loaded</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="x-incorrect-documentation-claims">❌ INCORRECT Documentation Claims<a class="anchor" aria-label="anchor" href="#x-incorrect-documentation-claims"></a></h3>
<p><strong>FALSE:</strong> “Simple library(ggplot2) works with Shinylive 0.8.0+” <strong>FALSE:</strong> “Shinylive automatically bundles all dependencies” <strong>REALITY:</strong> As of Jan 2025, ggplot2 STILL FAILS in WebR due to missing munsell</p>
</div>
<div class="section level3">
<h3 id="white_check_mark-actual-working-solutions">✅ ACTUAL Working Solutions<a class="anchor" aria-label="anchor" href="#white_check_mark-actual-working-solutions"></a></h3>
<div class="section level4">
<h4 id="option-1-dont-use-ggplot2-recommended">Option 1: Don’t Use ggplot2 (RECOMMENDED)<a class="anchor" aria-label="anchor" href="#option-1-dont-use-ggplot2-recommended"></a></h4>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use plotly instead - it actually works</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://plotly-r.com" class="external-link">plotly</a></span><span class="op">)</span></span>
<span><span class="fu">plot_ly</span><span class="op">(</span><span class="va">data</span>, x <span class="op">=</span> <span class="op">~</span><span class="va">x</span>, y <span class="op">=</span> <span class="op">~</span><span class="va">y</span>, type <span class="op">=</span> <span class="st">'scatter'</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="option-2-explicitly-install-dependencies-working-pattern-from-irishbuoys">Option 2: Explicitly Install Dependencies (WORKING PATTERN FROM irishbuoys)<a class="anchor" aria-label="anchor" href="#option-2-explicitly-install-dependencies-working-pattern-from-irishbuoys"></a></h4>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install munsell FIRST, then ggplot2 - order matters!</span></span>
<span><span class="fu">webr</span><span class="fu">::</span><span class="fu">install</span><span class="op">(</span><span class="st">"munsell"</span>, repos <span class="op">=</span> <span class="st">"https://repo.r-wasm.org"</span><span class="op">)</span></span>
<span><span class="fu">webr</span><span class="fu">::</span><span class="fu">install</span><span class="op">(</span><span class="st">"ggplot2"</span>, repos <span class="op">=</span> <span class="st">"https://repo.r-wasm.org"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>  <span class="co"># Now works!</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="option-3-wait-for-webr-to-fix-it-someday">Option 3: Wait for WebR to Fix It (SOMEDAY)<a class="anchor" aria-label="anchor" href="#option-3-wait-for-webr-to-fix-it-someday"></a></h4>
<p>Track issue at: <a href="https://github.com/r-wasm/webr/issues" class="external-link uri">https://github.com/r-wasm/webr/issues</a></p>
</div>
</div>
<div class="section level3">
<h3 id="clipboard-shinylive-deployment-checklist">📋 Shinylive Deployment Checklist<a class="anchor" aria-label="anchor" href="#clipboard-shinylive-deployment-checklist"></a></h3>
<p><strong>MANDATORY before EVERY deployment:</strong></p>
<ol style="list-style-type: decimal"><li>
<strong>Build locally</strong>: <code>quarto render dashboard_shinylive.qmd</code>
</li>
<li>
<strong>Check service worker</strong>: Verify <code>resources: - shinylive-sw.js</code> in YAML</li>
<li>
<strong>Open in browser</strong>: Not just curl - ACTUAL browser</li>
<li>
<strong>Check F12 console</strong> for:
<ul><li>❌ “munsell” errors</li>
<li>❌ CORS errors</li>
<li>❌ 404 on .wasm files</li>
<li>✅ “Service Worker registered”</li>
</ul></li>
<li>
<strong>Wait 60 seconds</strong>: Initial load is SLOW</li>
<li>
<strong>Test ALL tabs</strong>: Each module must render</li>
</ol></div>
<div class="section level3">
<h3 id="no_entry_sign-common-shinylive-mistakes-to-avoid">🚫 Common Shinylive Mistakes to Avoid<a class="anchor" aria-label="anchor" href="#no_entry_sign-common-shinylive-mistakes-to-avoid"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Assuming documentation is correct</strong> - Test everything</li>
<li>
<strong>Deploying without browser testing</strong> - Console errors only show in browser</li>
<li>
<strong>Using GitHub Releases for WASM</strong> - No CORS headers, use GitHub Pages</li>
<li>
<strong>Complex webr::mount() patterns</strong> - Gets stripped during build</li>
<li>
<strong>Trusting “it worked before”</strong> - WebR packages change frequently</li>
</ol></div>
<div class="section level3">
<h3 id="wrench-when-shinylive-fails">🔧 When Shinylive Fails<a class="anchor" aria-label="anchor" href="#wrench-when-shinylive-fails"></a></h3>
<p>If dashboard shows munsell error after deployment: 1. Remove ggplot2 completely 2. Use plotly for all visualizations 3. Test in browser before committing 4. Don’t believe documentation about “automatic bundling”</p>
</div>
<div class="section level3">
<h3 id="pencil-testing-command">📝 Testing Command<a class="anchor" aria-label="anchor" href="#pencil-testing-command"></a></h3>
<div class="sourceCode" id="cb48"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a><span class="co"># After building, ALWAYS test:</span></span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a><span class="ex">open</span> dashboard_shinylive.html</span>
<span id="cb48-3"><a href="#cb48-3" tabindex="-1"></a><span class="co"># Press F12, check Console tab</span></span>
<span id="cb48-4"><a href="#cb48-4" tabindex="-1"></a><span class="co"># Look for "munsell" or "ggplot2" errors</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="package-context-for-llms-pkgctx">Package Context for LLMs (pkgctx)<a class="anchor" aria-label="anchor" href="#package-context-for-llms-pkgctx"></a></h2>
<p>Generate compact API documentation for R/Python packages to provide Claude with function signatures and documentation. <strong>Reduces token usage by ~67%</strong> while preserving essential API information.</p>
<div class="section level3">
<h3 id="quick-usage-no-installation-required">Quick Usage (No Installation Required)<a class="anchor" aria-label="anchor" href="#quick-usage-no-installation-required"></a></h3>
<div class="sourceCode" id="cb49"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb49-1"><a href="#cb49-1" tabindex="-1"></a><span class="co"># Generate context for current package</span></span>
<span id="cb49-2"><a href="#cb49-2" tabindex="-1"></a><span class="ex">nix</span> run github:b-rodrigues/pkgctx <span class="at">--</span> r . <span class="at">--compact</span> <span class="op">&gt;</span> package.ctx.yaml</span>
<span id="cb49-3"><a href="#cb49-3" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" tabindex="-1"></a><span class="co"># Generate context for dependencies</span></span>
<span id="cb49-5"><a href="#cb49-5" tabindex="-1"></a><span class="ex">nix</span> run github:b-rodrigues/pkgctx <span class="at">--</span> r dplyr <span class="at">--compact</span> <span class="op">&gt;</span> .claude/context/dplyr.ctx.yaml</span>
<span id="cb49-6"><a href="#cb49-6" tabindex="-1"></a><span class="ex">nix</span> run github:b-rodrigues/pkgctx <span class="at">--</span> r targets <span class="at">--compact</span> <span class="at">--hoist-common-args</span> <span class="op">&gt;</span> .claude/context/targets.ctx.yaml</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="when-to-use-pkgctx">When to Use pkgctx<a class="anchor" aria-label="anchor" href="#when-to-use-pkgctx"></a></h3>
<ul><li>
<strong>Before asking Claude about package APIs</strong> - Provide context files in prompts</li>
<li>
<strong>CI/CD integration</strong> - Auto-update context on push, detect API drift</li>
<li>
<strong>Document dependencies</strong> - Keep <code>.claude/context/</code> with key package APIs</li>
<li>
<strong>Reduce token usage</strong> - Use <code>--compact</code> flag for ~67% reduction</li>
</ul></div>
<div class="section level3">
<h3 id="integration-pattern">Integration Pattern<a class="anchor" aria-label="anchor" href="#integration-pattern"></a></h3>
<div class="sourceCode" id="cb50"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb50-1"><a href="#cb50-1" tabindex="-1"></a><span class="co"># Generate contexts for frequently used packages</span></span>
<span id="cb50-2"><a href="#cb50-2" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> .claude/context</span>
<span id="cb50-3"><a href="#cb50-3" tabindex="-1"></a><span class="cf">for</span> pkg <span class="kw">in</span> dplyr tidyr purrr gert gh usethis devtools<span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb50-4"><a href="#cb50-4" tabindex="-1"></a>  <span class="ex">nix</span> run github:b-rodrigues/pkgctx <span class="at">--</span> r <span class="st">"</span><span class="va">$pkg</span><span class="st">"</span> <span class="at">--compact</span> <span class="op">&gt;</span> <span class="st">".claude/context/</span><span class="va">${pkg}</span><span class="st">.ctx.yaml"</span></span>
<span id="cb50-5"><a href="#cb50-5" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
<p><strong>Full details:</strong> See <code>llm-package-context</code> skill for CI workflows, API drift detection, and advanced usage.</p>
</div>
</div>
<div class="section level2">
<h2 id="session-end">Session End<a class="anchor" aria-label="anchor" href="#session-end"></a></h2>
<ol style="list-style-type: decimal"><li>Commit with <code>gert</code> (not bash)</li>
<li>Update <code>.claude/CURRENT_WORK.md</code>
</li>
<li>Push to remote</li>
<li>If wiki changed: <code>Rscript R/dev/wiki/sync_wiki.R</code>
</li>
</ol><p>```</p>
</div>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>

</div>



      <footer><div class="copyright">
  <p></p><p>Developed by John Gavin.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer></div>






  </body></html>

